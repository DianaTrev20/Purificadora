<div class="container mt-4">
  <h2 class="mb-4">Gestión de Compras</h2>

  <!-- Filtro de búsqueda -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="input-group">
        <span class="input-group-text">
          <i class="fas fa-search"></i>
        </span>
        <input type="text" class="form-control" placeholder="Buscar compras..." 
               (ngModel)="filtro">
      </div>
    </div>
    <div class="col-md-6 text-end">
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#nuevaCompraModal">
        <i class="fas fa-plus me-2"></i>Nueva Compra
      </button>
    </div>
  </div>

  <!-- Tabla de compras -->
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Proveedor</th>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Total</th>
          <th>Fecha</th>
          <th>Estado</th>
          <th>Notas</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let compra of compras">
          <td>{{ compra.id }}</td>
          <td>{{ compra.nombre_proveedor || 'Sin proveedor' }}</td>
          <td>{{ compra.nombre_producto || compra.producto_id }}</td>
          <td>{{ compra.cantidad }}</td>
          <td>${{ compra.costo_total | number:'1.2-2' }}</td>
          <td>{{ compra.fecha_compra | date:'dd/MM/yyyy' }}</td>
          <td>
            <span class="badge" 
                  [ngClass]="{
                    'bg-warning': compra.estado === 'pendiente',
                    'bg-success': compra.estado === 'completada',
                    'bg-danger': compra.estado === 'cancelada'
                  }">
              {{ compra.estado | uppercase }}
            </span>
          </td>
          <td>{{ compra.notas || '-' }}</td>
          <td>
            <div class="btn-group" role="group">
              <button class="btn btn-sm btn-outline-primary" 
                      *ngIf="compra.estado === 'pendiente'"
                      (click)="actualizarEstado(compra.id, 'completada')">
                <i class="fas fa-check"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger ms-1"
                      *ngIf="compra.estado !== 'cancelada'"
                      (click)="actualizarEstado(compra.id, 'cancelada')">
                <i class="fas fa-times"></i>
              </button>
              <button class="btn btn-sm btn-outline-secondary ms-1"
                      (click)="eliminarCompra(compra.id)">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        <tr *ngIf="compras.length === 0">
          <td colspan="9" class="text-center">No se encontraron compras</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal para nueva compra -->
<div class="modal fade" id="nuevaCompraModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Registrar Nueva Compra</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="crearCompra()">
          <div class="mb-3">
            <label class="form-label">Proveedor</label>
            <select class="form-select" id="select_proveedor_id" (change)="select_proveedor_cambiado($event.target.value)" (ngModel)="nuevaCompra.proveedor_id" name="proveedor" required>
              <option value="" disabled selected>Seleccione un proveedor</option>
              <option *ngFor="let proveedor of proveedores" [value]="proveedor.id">
                {{ proveedor.nombre }}
              </option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Producto</label>
            <select class="form-select" id="select_producto_id" (change)="select_producto_cambiado($event.target.value)" (ngModel)="nuevaCompra.producto_id" name="producto" required>
              <option value="" disabled selected>Seleccione un producto</option>
              <option *ngFor="let producto of productos" [value]="producto.id">
                {{ producto.nombre_producto }}
              </option>
            </select>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Cantidad</label>
              <input type="number" class="form-control" (change)="input_cantidad_cambiado($event.target.value)" (ngModel)="nuevaCompra.cantidad" 
                     name="cantidad" min="1" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Costo Total</label>
              <input type="number" (change)="input_costo_cambiado($event.target.value)" class="form-control" (ngModel)="nuevaCompra.costo_total" 
                     name="costo_total" min="0" step="0.01" required>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Fecha de Compra</label>
            <input type="date" class="form-control" (ngModel)="nuevaCompra.fecha_compra" 
                   name="fecha" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Estado</label>
            <select class="form-select" (ngModel)="nuevaCompra.estado" name="estado" required>
              <option *ngFor="let estado of estados" [value]="estado">
                {{ estado | uppercase }}
              </option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Notas</label>
            <textarea class="form-control" (change)="input_notas_cambiado($event.target.value)" (ngModel)="nuevaCompra.notas" name="notas"></textarea>
          </div>
          <div class="text-end">
            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary" data-bs-dismiss="modal">Guardar Compra</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>